# Fastlane configuration for Mangia

# Load env vars so EXPO_PUBLIC_* are available during Metro bundling.
# Fastlane natively loads fastlane/.env, but we also need the app's .env
# which lives one directory up. We read and inject it into ENV manually.
env_file = File.join(__dir__, '..', '.env')
if File.exist?(env_file)
  File.readlines(env_file).each do |line|
    line = line.strip
    next if line.empty? || line.start_with?('#')
    key, value = line.split('=', 2)
    ENV[key] = value if key && value && !ENV.key?(key)
  end
end

default_platform(:ios)

platform :ios do
  # App Store Connect API key â€” no password prompts, no 2FA, no session expiry
  def api_key
    app_store_connect_api_key(
      key_id: "GZH428625Q",
      issuer_id: "166b49fe-7da6-45ec-b392-0aa2f5d391a2",
      key_filepath: File.join(__dir__, "AuthKey_GZH428625Q.p8"),
    )
  end

  desc "Upload metadata and screenshots to App Store Connect"
  lane :upload_metadata do
    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: false,
      force: true,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Upload only screenshots to App Store Connect"
  lane :upload_screenshots do
    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: false,
      force: true
    )
  end

  desc "Upload only metadata (no screenshots) to App Store Connect"
  lane :upload_metadata_only do
    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true
    )
  end

  desc "Download existing metadata from App Store Connect"
  lane :download_metadata do
    deliver(
      api_key: api_key,
      download_metadata: true,
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    # Increment build number
    increment_build_number(
      xcodeproj: "ios/Mangia.xcodeproj"
    )

    # Fetch certificates and provisioning profiles via match
    match(
      type: "appstore",
      api_key: api_key,
      readonly: true
    )

    main_profile_name = ENV["sigh_com.airowe.mangia_appstore_profile-name"]
    share_profile_name = ENV["sigh_com.airowe.mangia.share-extension_appstore_profile-name"]
    live_activity_profile_name = ENV["sigh_com.airowe.mangia.MangiaLiveActivity_appstore_profile-name"]

    # Switch all targets to manual signing with distribution profiles
    # (expo prebuild --clean resets to automatic signing)
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Mangia.xcodeproj",
      team_id: "7WWYCV9VT8",
      code_sign_identity: "Apple Distribution",
      profile_name: main_profile_name,
      targets: ["Mangia"]
    )

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Mangia.xcodeproj",
      team_id: "7WWYCV9VT8",
      code_sign_identity: "Apple Distribution",
      profile_name: share_profile_name,
      targets: ["ShareExtension"]
    )

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Mangia.xcodeproj",
      team_id: "7WWYCV9VT8",
      code_sign_identity: "Apple Distribution",
      profile_name: live_activity_profile_name,
      targets: ["MangiaLiveActivity"]
    )

    # Build the app
    build_app(
      workspace: "ios/Mangia.xcworkspace",
      scheme: "Mangia",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Mangia.ipa",
      export_options: {
        provisioningProfiles: {
          "com.airowe.mangia" => main_profile_name,
          "com.airowe.mangia.share-extension" => share_profile_name,
          "com.airowe.mangia.MangiaLiveActivity" => live_activity_profile_name
        }
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end

  desc "Upload an existing IPA to TestFlight"
  lane :upload_testflight do |options|
    ipa_path = options[:ipa] || "./build/mangia.ipa"

    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      apple_id: "6758270890"
    )
  end
end
